<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>投屏遥控</title>
  <style>
    :root {
      --bg: #f3f5ff;
      --card: #ffffff;
      --text: #111827;
      --muted: #64748b;
      --primary: #4f46e5;
      --primary-soft: #e9e7ff;
      --danger: #ef4444;
      --border: #e5e7eb;
    }

    * { box-sizing: border-box; }

    html,
    body {
      width: 100%;
      height: 100%;
      margin: 0;
      color: var(--text);
      background: radial-gradient(1200px 600px at 0% -10%, #dbe4ff 0%, transparent 70%), var(--bg);
      font-family: "SF Pro Text", "PingFang SC", "Noto Sans SC", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    .app {
      height: 100dvh;
      display: flex;
      flex-direction: column;
      padding: 12px;
      gap: 10px;
    }

    .panel {
      background: var(--card);
      border: 1px solid #eef2ff;
      border-radius: 14px;
      box-shadow: 0 8px 24px rgba(79, 70, 229, 0.08);
    }

    .top {
      padding: 12px;
      position: sticky;
      top: 0;
      z-index: 3;
    }

    .title {
      margin: 0;
      font-size: 16px;
      font-weight: 700;
      text-align: center;
    }

    .meta {
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
      text-align: center;
    }

    .status {
      margin-top: 8px;
      font-size: 12px;
      text-align: center;
      color: var(--primary);
      min-height: 16px;
    }

    .status.error {
      color: var(--danger);
    }

    .controls {
      margin-top: 10px;
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: 8px;
    }

    .ctrl {
      border: 0;
      border-radius: 12px;
      height: 44px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 600;
      color: #fff;
      background: linear-gradient(135deg, #5b7bff 0%, #6457f6 100%);
      box-shadow: 0 6px 12px rgba(79, 70, 229, 0.24);
    }

    .ctrl.stop {
      background: linear-gradient(135deg, #ff6b6b 0%, #ef4444 100%);
      box-shadow: 0 6px 12px rgba(239, 68, 68, 0.24);
    }

    .ctrl:active {
      transform: translateY(1px);
    }

    .ctrl:disabled {
      opacity: 0.6;
    }

    .list-wrap {
      min-height: 0;
      flex: 1;
      padding: 6px;
      overflow: hidden;
    }

    .list {
      height: 100%;
      overflow: auto;
      -webkit-overflow-scrolling: touch;
      padding: 2px;
      border-radius: 12px;
    }

    .item {
      width: 100%;
      border: 1px solid var(--border);
      border-radius: 12px;
      margin-bottom: 8px;
      padding: 11px;
      background: #fff;
      text-align: left;
    }

    .item.on {
      border-color: var(--primary);
      background: var(--primary-soft);
      box-shadow: 0 4px 12px rgba(79, 70, 229, 0.12);
    }

    .item-title {
      font-size: 14px;
      line-height: 1.35;
      font-weight: 600;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
      word-break: break-word;
    }

    .item-sub {
      margin-top: 4px;
      font-size: 12px;
      color: var(--muted);
    }
  </style>
</head>
<body>
  <main class="app">
    <section class="panel top">
      <h1 class="title">手机遥控投屏</h1>
      <div id="meta" class="meta">连接中...</div>
      <div id="status" class="status">正在同步状态...</div>
      <div class="controls">
        <button id="prev" class="ctrl" title="上一集">上一集</button>
        <button id="pause" class="ctrl" title="暂停/继续">暂停</button>
        <button id="next" class="ctrl" title="下一集">下一集</button>
        <button id="stop" class="ctrl stop" title="停止投屏">停止</button>
      </div>
    </section>

    <section class="panel list-wrap">
      <div id="list" class="list"></div>
    </section>
  </main>

  <script>
    const sid = location.pathname.split('/').pop();
    let latestState = null;

    async function api(path, method = 'GET') {
      const response = await fetch('/cast/api/' + sid + path, {
        method,
        headers: { 'Content-Type': 'application/json' },
      });
      if (!response.ok) {
        throw new Error(await response.text());
      }
      const data = await response.json();
      if (data && data.ok === false) {
        throw new Error(data.error || '操作失败');
      }
      return data;
    }

    function esc(input) {
      return String(input || '').replace(/[&<>"']/g, (match) => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;',
      }[match]));
    }

    function setStatus(text, isError) {
      const status = document.getElementById('status');
      status.textContent = text;
      status.className = isError ? 'status error' : 'status';
    }

    async function refresh() {
      try {
        const state = await api('/state');
        latestState = state;
        document.getElementById('meta').textContent = '设备: ' + state.device_id + ' · 当前: ' + (state.current_index + 1) + '/' + state.items.length;

        if (state.last_error) {
          setStatus('错误: ' + state.last_error, true);
        } else if (state.is_loading) {
          setStatus('正在切换视频，请稍候...', false);
        } else {
          setStatus('已连接，可直接点列表切换播放', false);
        }

        const pauseBtn = document.getElementById('pause');
        pauseBtn.textContent = state.is_paused ? '继续' : '暂停';

        const list = document.getElementById('list');
        list.innerHTML = '';
        state.items.forEach((item, index) => {
          const node = document.createElement('button');
          node.className = 'item' + (index === state.current_index ? ' on' : '');
          node.innerHTML = '<div class="item-title">' + esc(item.title) + '</div><div class="item-sub">第 ' + (index + 1) + ' 项</div>';
          node.onclick = () => api('/play/' + index, 'POST').then(refresh).catch((e) => {
            alert(e.message || e);
          });
          list.appendChild(node);
        });
      } catch (error) {
        console.error(error);
        setStatus('连接失败，请确认与电脑在同一局域网', true);
      }
    }

    function bindControl(id, path) {
      document.getElementById(id).onclick = () => {
        api(path, 'POST')
          .then(refresh)
          .catch((e) => alert(e.message || e));
      };
    }

    bindControl('prev', '/prev');
    bindControl('next', '/next');
    bindControl('pause', '/toggle-pause');
    bindControl('stop', '/stop');

    refresh();
    setInterval(() => {
      if (!latestState || !latestState.is_loading) {
        refresh();
        return;
      }
      refresh();
    }, 2000);
  </script>
</body>
</html>
